#!/bin/bash -e

# ===========================================================================
# Docker Entrypoint Script
# ===========================================================================
# This script runs before the main container command.
# It handles database preparation and other initialization tasks.
# ===========================================================================

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
  echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

# Database preparation
prepare_database() {
  log_info "Preparing database..."
  
  # Wait for database to be ready
  max_attempts=30
  attempt=0
  
  while [ $attempt -lt $max_attempts ]; do
    if ./bin/rails runner "ActiveRecord::Base.connection" 2>/dev/null; then
      log_info "Database connection successful"
      break
    fi
    
    attempt=$((attempt + 1))
    log_warn "Waiting for database... (attempt $attempt/$max_attempts)"
    sleep 2
  done
  
  if [ $attempt -eq $max_attempts ]; then
    log_error "Could not connect to database after $max_attempts attempts"
    exit 1
  fi
  
  # Run database setup/migrations
  if ./bin/rails db:prepare; then
    log_info "Database prepared successfully"
  else
    log_error "Database preparation failed"
    exit 1
  fi
}

# Main execution
log_info "Starting entrypoint script..."

# If running the rails server, prepare the database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  prepare_database
fi

# If running sidekiq, also prepare the database (for worker containers)
if [[ "${1}" == *"sidekiq"* ]] || [[ "${2}" == *"sidekiq"* ]]; then
  prepare_database
fi

log_info "Entrypoint script completed. Starting application..."

# Execute the main command
exec "${@}"
